#!/usr/bin/env ruby
require 'optparse'
require 'GeneValidatorApp'
require 'GeneValidatorApp/PreRunValidation.rb'
require 'sinatra'
require 'pathname'

opt = {}
optparse = OptionParser.new do |opts|
  opts.banner = <<Banner

* Usage: genevalidatorapp [options]

* Available Options

Banner

  opt['config_file'] = File.join(Dir.home, '.genevalidatorapp.conf')
  opts.on('-c', '--config CONFIG_FILE', 'Use the given configurationfile') do |config_file|
    opt['config_file'] = config_file
  end

  opt[:debug] = false
  opts.on('-d', '--debug', 'Provides more information on each step taken in',
          ' this program') do
    opt[:debug] = true
  end

  opt[:port] = 4567
  opts.on('-p', '--port PORT', 'Run the app at a port of your choice.') do |port|
    opt[:port] = port
  end

  opts.on('-v', '--version', 'Shows version') do
    puts GeneValidatorApp::VERSION
    exit
  end

  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    exit
  end
end
optparse.parse!

# SET UP & START APP...

tempdir   = Pathname.new(Dir.mktmpdir('GeneValidator_'))
root      = Pathname.new(__FILE__).dirname.parent

dbs       = GeneValidatorApp::Prerun.validate(opt[:debug], opt['config_file'],
                                              tempdir, root)

GVversion = GeneValidatorApp::Prerun.current_gv_version

GVapp.set :environment, :production
GVapp.set :root, Pathname.new(__FILE__).dirname.parent
GVapp.set :port, opt[:port].to_i
GVapp.set :GVversion, GVversion
GVapp.set :tempdir, tempdir
GVapp.set :dbs, dbs[:dbs]
GVapp.set :non_default, dbs[:rest_dbs]
GVapp.set :default_db, dbs[:default_db]
GVapp.run!
