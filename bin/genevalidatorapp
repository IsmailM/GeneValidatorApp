#!/usr/bin/env ruby

require 'sinatra'
require 'slim'
require 'fileutils'
require 'sinatra/base'
require 'GeneValidatorApp'
require "sinatra/config_file" # TODO: do we still need this... 
require 'thin'
#require 'genevalidator'

# AnuragPriyam: 
# * check the manner in which temp files are stored and served. 


class GVapp < Sinatra::Base
  helpers GeneValidatorApp

  set :root, "#{File.dirname(__FILE__)}/../"
  register Sinatra::ConfigFile
  config_file "#{File.dirname(__FILE__)}/../config.yml"
  # Remove before Release When false, it compresses the rendered HTML.
  Slim::Engine.default_options[:pretty] = true

  before do
    @tempdir          = settings.tempdir
    @unique_name      = create_unique_name
    @working_folder   = File.join(@tempdir, @unique_name)
    @unique_name      = ensure_unique_name(@working_folder) if File.exist?(@working_folder)
    @public_folder    = File.join("#{File.dirname(__FILE__)}", '..', 'public', 'GeneValidator', @unique_name)
    raise IOError, 'A unique name cannot be created for this session.' if File.exist?(@working_folder)
  end

  get '/' do
    slim :index
  end

  post '/input' do
    # Set up Variables 
    sequences        = params[:seq]
    validation_array = params[:validations].to_s.gsub(/[\[\]\"\,]/, '')
    database         = params[:database]
    # Create the working folder (within the temp folder). and then creating
    #   a soft link in the public folder to the working folder.
    FileUtils.mkdir_p @working_folder
    FileUtils.ln_s "#{@working_folder}", "#{@public_folder}"
    # Ensuring seqs are in fasta and then writing them to file.
    sequences = to_fasta(sequences)
    create_fasta_file(@working_folder, sequences)
    results = run_genevalidator(validation_array, @working_folder, @public_folder, @unique_name)

    create_results(results)
  end

  # TODO: Get the below to work...
  # get '/results/*' do
  #   @existing_unique_name      = params[:splat]
  #   @existing_public_folder    = File.join("#{File.dirname(__FILE__)}", '/../public/GeneValidator', @existing_unique_name)

  #   if File.exist?(@existing_public_folder)
  #     @results = IO.read("#{@existing_public_folder}/table.html")
  #   else
  #     @results = "Sorry, no results can be found at this URL. Please try again."
  #   end

  #   slim :index
  # end
end

GVapp.set :tempdir, Dir.mktmpdir('GeneValidator_')
GVapp.run!

